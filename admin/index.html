<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ููุญุฉ ุงูุชุญูู - ุดุจูุฉ ุงูุจุฑู</title>
    <link rel="stylesheet" href="../css/style.css">
</head>
<body>
    <div class="container">
        <div class="header">
            <div>
                <h1>๐๏ธ ููุญุฉ ุงูุชุญูู</h1>
                <p>ุฅุฏุงุฑุฉ ุงูุจุทุงูุงุช ูุงูุญููุงุช</p>
            </div>
            <div class="header-actions">
                <a href="create-card.php" class="btn btn-success" style="width: auto; padding: 10px 20px;">
                    โ ุฅูุดุงุก ุจุทุงูุฉ ุฌุฏูุฏุฉ
                </a>
                <a href="schedule-manager.html" class="btn btn-secondary" style="width: auto; padding: 10px 20px;">
                    ๐ ุฅุฏุงุฑุฉ ุงูุฌุฏูู
                </a>
                <button onclick="logout()" class="btn btn-danger" style="width: auto; padding: 10px 20px;">
                    ุชุณุฌูู ุงูุฎุฑูุฌ
                </button>
            </div>
        </div>
        
        <div class="glass-card">
            <h2 style="margin-bottom: 20px;">ุงูุจุทุงูุงุช ุงููุณุฌูุฉ</h2>
            
            <div class="table-container">
                <table id="cards-table">
                    <thead>
                        <tr>
                            <th>ุฑูู ุงูุจุทุงูุฉ</th>
                            <th>ุนุฏุฏ ุงูุญููุงุช</th>
                            <th>ุงูุฃุฌูุฒุฉ ุงููุชุตูุฉ</th>
                            <th>ุงูุญุงูุฉ</th>
                            <th>ุชุงุฑูุฎ ุงูุฅูุดุงุก</th>
                            <th>ุงูุฅุฌุฑุงุกุงุช</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td colspan="6" style="text-align: center;">
                                <div class="loading">
                                    <div class="spinner"></div>
                                    <p>ุฌุงุฑู ุชุญููู ุงูุจุทุงูุงุช...</p>
                                </div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <script src="../js/main.js"></script>
    <script>
        let cards = [];
        
        async function loadCards() {
            const result = await apiRequest('get-all-cards.php');
            
            if (!result.success) {
                showAlert(result.message, 'error');
                if (result.message.includes('ุบูุฑ ูุตุฑุญ')) {
                    setTimeout(() => {
                        window.location.href = 'login.html';
                    }, 2000);
                }
                return;
            }
            
            cards = result.data.cards;
            displayCards();
        }
        
        function displayCards() {
            const tbody = document.querySelector('#cards-table tbody');
            
            if (cards.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">ูุง ุชูุฌุฏ ุจุทุงูุงุช ูุณุฌูุฉ</td></tr>';
                return;
            }
            
            tbody.innerHTML = cards.map(card => `
                <tr>
                    <td><strong>${card.card_number}</strong></td>
                    <td>${card.episodes_count} / ${card.max_episodes}</td>
                    <td>${card.connected_devices} / ${card.max_devices}</td>
                    <td>
                        <span class="status-badge status-${card.status}">
                            ${card.status === 'active' ? 'ูุดุท' : 'ูุนูู'}
                        </span>
                    </td>
                    <td>${formatDate(card.created_at)}</td>
                    <td>
                        <button onclick="toggleCardStatus('${card.card_number}', '${card.status}')" 
                                class="btn ${card.status === 'active' ? 'btn-danger' : 'btn-success'}" 
                                style="padding: 5px 10px; font-size: 0.85rem; margin-left: 5px;">
                            ${card.status === 'active' ? 'โธ๏ธ ุชุนููู' : 'โถ๏ธ ุชูุนูู'}
                        </button>
                        <button onclick="deleteCard('${card.card_number}')" 
                                class="btn btn-danger" 
                                style="padding: 5px 10px; font-size: 0.85rem;">
                            ๐๏ธ ุญุฐู
                        </button>
                    </td>
                </tr>
            `).join('');
        }
        
        async function toggleCardStatus(cardNumber, currentStatus) {
            const newStatus = currentStatus === 'active' ? 'suspended' : 'active';
            const action = newStatus === 'suspended' ? 'ุชุนููู' : 'ุชูุนูู';
            
            if (!confirm(`ูู ุชุฑูุฏ ${action} ุงูุจุทุงูุฉ ${cardNumber}ุ`)) {
                return;
            }
            
            showLoading(true);
            
            const formData = new FormData();
            formData.append('card_number', cardNumber);
            formData.append('status', newStatus);
            
            const result = await apiRequest('update-card-status.php', 'POST', formData);
            
            showLoading(false);
            
            if (result.success) {
                showAlert(result.message, 'success');
                loadCards();
            } else {
                showAlert(result.message, 'error');
            }
        }
        
        async function deleteCard(cardNumber) {
            if (!confirm(`ูู ุฃูุช ูุชุฃูุฏ ูู ุญุฐู ุงูุจุทุงูุฉ ${cardNumber}ุ\nุณูุชู ุญุฐู ุฌููุน ุงูุญููุงุช ูุงููููุงุช ุงููุฑุชุจุทุฉ ุจูุง.`)) {
                return;
            }
            
            showLoading(true);
            
            const formData = new FormData();
            formData.append('card_number', cardNumber);
            
            const result = await apiRequest('delete-card.php', 'POST', formData);
            
            showLoading(false);
            
            if (result.success) {
                showAlert(result.message, 'success');
                loadCards();
            } else {
                showAlert(result.message, 'error');
            }
        }
        
        function logout() {
            if (confirm('ูู ุชุฑูุฏ ุชุณุฌูู ุงูุฎุฑูุฌุ')) {
                apiRequest('logout.php').then(() => {
                    window.location.href = 'login.html';
                });
            }
        }
        
        loadCards();
        setInterval(loadCards, 30000);
    </script>
</body>
</html>
